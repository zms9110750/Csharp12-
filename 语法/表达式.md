# 表达式

## 语句

c#中，一个表达式想要单独放置，那么必须是以下情况之一[^必须是最后计算]：

[^必须是最后计算]:一条表达式可能有很复杂的计算过程。这里只考虑这个表达式最后执行的计算。

- 方法调用
    - `new`构造
- 声明变量
- 变量赋值
    - 自增，自减，

```csharp
"hello";  
new string("hello");
//上面两种方式得到的值是一样的，但使用new的语句可以独立成句，字面量则不行。

"hello".ToString().Length;//最后是获取值，不行。
"hello".Length.ToString();//最后是调用方法，可以

"hello" + "world".ToString();//先调用方法，把结果和另一方相加。相加是最后计算的，不行。
("hello" + "world").ToString();//使用括号改变顺序，先相加，最后是调用方法。可以
```

### 语句也能参与表达式

可以作为语句单独存在的表达式，不意味着它只能作为最后的计算。  

```csharp
Random.Shared.Next(10);//调用方法
int i = Random.Shared.Next(10) * 10;

i = 20;//赋值
int i2 = (i = 30) * 10;

i++;//自增
i = 20 + i++;
```

### 舍弃

赋值语句可以为`_`进行赋值，以组成一个赋值语句，但不使用任何变量接收。[^没有声明_]

[^没有声明_]:`_`是一个合法的变量名。这里要求在此前没有声明过这个名字的变量。

```csharp
int a = 1, b = 2, n = 3;
_ = n < 6 ? a++ : b++;
```


## 运算顺序[^运算顺序参考]

[^运算顺序参考]:更详细的介绍请参阅<https://learn.microsoft.com/zh-cn/dotnet/csharp/language-reference/operators/#operator-precedence>

c#中，运算顺序大体可认为：  

1. 成员访问
1. 一元运算[^一元和二元]
    1. 前置运算符
    2. 后置表达式
1. 二元运算[^一元和二元]
    1. 数学运算
    2. 比较运算
    3. 逻辑运算
1. 条件表达式
1. 赋值

[^一元和二元]:一元和二元是指，这个运算由几个参数参与。  
例如，`1`和`-1`是相反数。但如果对变量使用，`a`和`-a`，  
`-a`前面的负号是一个运算符，表示取相反数，只需要一个参数。

## 取值表达式

### 成员访问

一个类型的值可以通过`.`来访问这个值的成员。  
或是通过`[]`和参数来访问这个值的成员，例如`"hello"[2]`，  
就像方法调用一样，在里面填参数。

### 条件表达式

条件表达式在一个`bool`后附由`:`隔开的两个值。  
`string s = i % 2 == 0 ? "偶数" : "奇数";`。  

条件表达式的类型取决于两个候选值的共同类型。[^不能是object]
[^不能是object]:如果共同类型只有`object`，那么除非接受者也是`object`的变量，否则编译不通过。


条件表达式的候选值可以嵌套条件表达式。[^右侧嵌套]
[^右侧嵌套]:但一般只在右侧嵌套，这样具有比较好的可读性。

```csharp
int i2 = 10;
string s2 = i2 < 2 ? "S"
 : i2 < 4 ? "A"
 : i2 < 10 ? "B"
 : "C";
```

### switch表达式

`switch`是一个后置表达式，他要判断的值是关键字左侧的值。  
`switch`表达式是`switch`选择的简化。

- 可以判断多个候条件和候选项
- `=>`左侧是候选条件，右侧是候选值。合起来叫分支臂，分支臂之间用逗号隔开
- 主条件只能使用模式匹配
- 次条件使用`when`跟随条件
- 匹配条件是有序处理，前者满足就不会再判断剩余项
- 可以使用`_`表示默认，匹配任何情况
- 如果没有匹配成功，运行时报错

```csharp
int i = 0;
string s = (i % 2) switch   //switch是一元表达式，优先级高于二元运算。处理二元运算结果必须加括号
{
    0 => "偶数",
    1 => "奇数",
};

int a = 1, b = 2;
var s2 = a switch
{
	_ when a < b => true,
	1 => true,
	2 when a > b => true,
	_ => false
};
```

### with表达式

对于结构或记录，可以对一个后使用`with`和初始化器语法克隆出一个新值。  
在初始化器里写的会覆盖，没写的会和被克隆的值一样。

```csharp
System.Numerics.Vector3 vector = new System.Numerics.Vector3() { X = 3, Y = 4, Z = 5 };
var vec2 = vector with { X = 6 };// X=6 , Y=4 , Z=5
```

### 插值字符串[^空格占位]

在字符串前加上`$`修饰，可以将字符串改为插值字符串格式。  

- 插值字符串中的大括号对会被认为占位符。  
  里面使用表达式并计算表达式的值
- 插值字符串里使用大括号时，需要连写两个来转义
- 原始字符串可以加上多个`$`修饰，  
若如此做，需要使用同等数量的连续`{`和`}`来启用和结束占位。

```csharp
string name1 = "小明";
int age1 = 12;
Console.WriteLine($"名字是:{name1}，年龄是{age1}，转义后的大括号{{}}");
Console.WriteLine($$$"""名字是:{{{name1}}}，年龄是{{{age1}}}""");
```

[^空格占位]:
#### 空格占位
在插值后，可以接一个逗号和一个常量，表示这个值至少要占多少个字符。  
如果没有达到指定数量，就会用空格补齐。达到或超过则无事发生。  
如果是正数，空格会补在前面，如果是负数，空格会补在后面。  
```csharp
Console.WriteLine($"123456789012345678901234567890");
Console.WriteLine($"12|{456,6}0|23456789|{123,-7}|90");
```

#### 格式说明符

在插值后（或空格占位后）可以加上冒号[^插值歧义]来描述这个类型的格式说明。    
格式说明是由类型单独[定义](https://learn.microsoft.com/zh-cn/dotnet/standard/base-types/standard-numeric-format-strings)的。

[^插值歧义]:此时使用条件表达式会有歧义，插值字符串里的条件表达式应当使用括号包围。

```csharp
double e = 12.123456;
int f = 285;
Console.WriteLine($"{f:d5}");//00285，以前导0补足指定数量的数字
Console.WriteLine($"{f:x}");//11d，以16进制显示。字母部分的大小写取决于说明符的大小写
Console.WriteLine($"{d:f3}");//12.123，指定小数位数,会四舍五入或补0来达到指定位数
Console.WriteLine($"{d:e2}");//1.21e+001，科学计数法显示，e后面的数字即小数点后的有效数字，四舍五入
```

## 一元运算

### 自增，自减

`i++`,`i--`,`++i`,`--i`表示自增或自减。  
进行一次`+1`运算或`-1`运算，然后替换掉原来的值。  

接着取值，如果`++`在前面，就表示先替换，再取值（取替换后的值）。  
如果`++`在后面，就取记录原值再替换，然后取原值。

### 本身，相反数

如果自己前面有`+`，则啥也不干，  
如果自己前面有`-`，则取自己的相反数。

### 取反

整数类型前面加`~`表示把二进制表示的数字全部逆转，  
按照整数的储存规则，这相当于这个数的相反数再加1.

`bool`类型前面可以加`!`，也表示取相反的值。

## 二元运算

### 数学运算

`+`,`-`,`*`,`/`分别表示对应的数学运算。  
另外，`%`表示取余数。

### 位移

`<<`,`>>`表示把数字的二进制表示数挪动指定位。  
溢出的截断，空位补0。从效果上来说，相当于`*2`或`/2`重复指定次数。

### 比较

`<`,`>`,`<=`,`>=`,`==`,`!=`可以比较两个值的关系。  
由于`=`表示赋值，所以相等用`==`表示。  
不相等使用表示逆转的`!`和`=`结合表示。  
这当中所有有`=`出现的运算符，`=`都在右边。

### 逻辑运算

- `&`：与/且  
  当两者同时满足条件时，计算结果为条件满足。
- `|`：或/任一  
  当两者有任何一个满足时，计算结果为条件满足。
- `^`：异或  
  当两者不相同时，计算结果为条件满足。

`&`,`|`与`&&`,`||`的差别：
  -  `&`,`|`既可以对整数用，也可以对`bool`用。  
    对整数用时，会对两个数字的二进制表示依次对每个位做逻辑运算。
  - `&&`,`||`只能对`bool`用。  
    如果左侧能得到结果，就不会对右侧取值和执行最终计算。  
    相当于`x || y`=`x ? x : x | y ` , `x && y`=` !x ? x : x & y`  
  - 即用于优化性能，也在有前置条件的代码中阻断错误。  
    例如整数除法不能除0：`_ = (i != 0) && ((10 / i) > 2);`