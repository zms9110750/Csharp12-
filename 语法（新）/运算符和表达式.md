# 表达式

## 语句

c#中，一个表达式中参与运算的值可能是另一个表达式。  
无论中间的计算步骤如何，如果一条表达式要独立成句，最后计算的必须是以下情况之一：

- 方法调用
- 声明变量
- 变量赋值
- 自增，自减，
- `new`构造

```csharp
"hello";  
new string("hello");
//上面两种方式得到的值是一样的，但使用new的语句可以独立成句，字面量则不行。

"hello".ToString().Length;//最后是获取值，不行。
"hello".Length.ToString();//最后是调用方法，可以

"hello" + "world".ToString();//先调用方法，把结果和另一方相加。相加是最后计算的，不行。
("hello" + "world").ToString();//使用括号改变顺序，先相加，最后是调用方法。可以
```

### 舍弃

如果中途的计算步骤会导致值改变，而最后的结果不能独立成句，  
可以利用舍弃赋值来组成赋值语句。

如果先前没有声明标识符为`_`的变量，则可以使用`_`作为被赋值的结果。  

```csharp
int a = 1, b = 2, n = 3;
_ = n < 6 ? a++ : b++;
```

## 运算顺序

c#中很多能独立成句的表达式也能同时作为取值参与进表达式的计算。  
例如赋值语句，方法调用（只要方法返回不是`void`），自增。

1. 成员访问，关键字取值，后置一元运算
    - `x.y`、`f(x)`、`a[i]`、`x?.y`、`x?[y]`、`x->y`
    - `typrof`、`sizeof`、`nameof`
    - `x++`、`x--`
1. 前置一元运算
    - `+x`、`-x`、`!x`、`~x`、`++x`、`--x`、`^x`、`(T)x`
1. 后置关键字取值表达式
    - `switch`表达式、`with`表达式
1. 二元运算
    1. 数学运算
        1. 乘除
        1. 加减
        1. 位移
    1. 比较运算
        1. 大于，小于，不大于，不小于
        1. 相等，不相等
    1. 位运算
        1. 与
        1. 异或
        1. 或
    1. 逻辑运算
        1. 逻辑与
        1. 逻辑或
1. 空合并
1. 条件表达式
1. 赋值语句

### 运算结合

当运算符的优先级相同，运算符的结合性决定了运算的执行顺序：

- 左结合运算符按从左到右的顺序计算。   
除`赋值`和 `空合并`外，所有二元运算符都是左结合运算符。   
例如，`a + b - c` 将计算为 `(a + b) - c`。
- 右结合运算符按从右到左的顺序计算。      
例如，x = y = z 将计算为 x = (y = z)。

使用括号更改运算符结合性所施加的计算顺序：

```csharp
int a = 13 / 5 / 2;
int b = 13 / (5 / 2);
Console.WriteLine($"a = {a}, b = {b}");  // output: a = 1, b = 6
```

### 合并赋值

二元运算的赋值语句，如果操作是把自己和一个值运算，然后赋值给自己，那么可以简写。

```csharp
int i = 10;
i += 10;
i >>= 2;
```

## 一元运算

### 自增，自减

`i++`,`i--`,`++i`,`--i`表示自增或自减。  
进行一次`+1`运算或`-1`运算，然后替换掉原来的值。  

接着取值，如果`++`在前面，就表示先替换，再取值（取替换后的值）。  
如果`++`在后面，就取记录原值再替换，然后取原值。

### 本身，相反数

如果自己前面有`+`，则啥也不干，  
如果自己前面有`-`，则取自己的相反数。

### 取反

整数类型前面加`~`表示把二进制表示的数字全部逆转，  
按照整数的储存规则，这相当于这个数的相反数再加1.

`bool`类型前面可以加`!`，也表示取相反的值。

## 二元运算

### 数学运算

`+`,`-`,`*`,`/`分别表示对应的数学运算。  
另外，`%`表示取余数。

### 位移

`<<`,`>>`表示把数字的二进制表示数挪动指定位。  
溢出的截断，空位补0。从效果上来说，相当于`*2`或`/2`重复指定次数。

### 比较

`<`,`>`,`<=`,`>=`,`==`,`!=`可以比较两个值的关系。  
由于`=`表示赋值，所以相等用`==`表示。  
不相等使用表示逆转的`!`和`=`结合表示。  
这当中所有有`=`出现的运算符，`=`都在右边。

### 逻辑运算

- `&`：与/且  
  当两者同时满足条件时，计算结果为条件满足。
- `|`：或/任一  
  当两者有任何一个满足时，计算结果为条件满足。
- `^`：异或  
  当两者不相同时，计算结果为条件满足。
- `&`,`|`与`&&`,`||`的差别：
  -  `&`,`|`既可以对整数用，也可以对`bool`用。  
    对整数用时，会对两个数字的二进制表示依次对每个位做逻辑运算。
  - `&&`,`||`只能对`bool`用。  
    如果左侧能得到结果，就不会对右侧取值和执行最终计算。  
    相当于`x || y`=`x ? x : x | y ` , `x && y`=` !x ? x : x & y`  
  - 即用于优化性能，也在有前置条件的代码中阻断错误。  
    例如整数除法不能除0：`_ = (i != 0) && ((10 / i) > 2);`

## 取值表达式

### 条件表达式

条件表达式在一个`bool`后附由`:`隔开的两个值。  
`string s = i % 2 == 0 ? "偶数" : "奇数";`。  

右侧的两个值必须能转为同一类型，这样整个表达式才能得到合理的类型。

三元表达式可以嵌套，但一般在右侧候选值嵌套，以便于理解。

```csharp
int i2 = 10;
string s2 = i2 < 2 ? "S"
 : i2 < 4 ? "A"
 : i2 < 10 ? "B"
 : "C";
```

### switch表达式

`switch`表达式可以比较多个候选条件和候选值。
`switch`是一个后置表达式，他要判断的值是关键字左侧的值。

```csharp
int i = 0;
string s = (i % 2) switch   //switch是一元表达式，优先级高于二元运算。处理二元运算结果必须加括号
{
    0 => "偶数",
    1 => "奇数",
    _ => "错误结果"
};
```

`=>`左侧是候选条件，右侧是候选值。合起来叫分支臂，分支臂之间用逗号隔开。  
用舍弃表示任何情况下都满足条件。可以不包含舍弃，但如果运行到了不能匹配的情况会报错。

分支的条件后可以用`when`附加一个次要判断，这个判断可以包含变量。

```csharp
int a = 1, b = 2;
var s2 = a switch
{
	_ when a < b => true,
	1 => true,
	2 when a > b => true,
	_ => false
};
```

### 内联抛出异常

在条件表达式和`switch`表达式中，候选项可以用抛出异常代替。  
但至少有一个候选项是普通的值。

```csharp
int i = 0;
string s = (i % 2) switch
{
    0 => "偶数",
    1 => "奇数",
    _ => throw new Exception("错误结果")
};
var s2 = i % 2 == 0 ? "偶数" : throw new Exception("此处不应该是奇数");
```

### with表达式

对于结构或记录，可以对一个后使用`with`和初始化器语法克隆出一个新值。  
在初始化器里写的会覆盖，没写的会和被克隆的值一样。

```csharp
System.Numerics.Vector3 vector = new System.Numerics.Vector3() { X = 3, Y = 4, Z = 5 };
var vec2 = vector with { X = 6 };// X=6 , Y=4 , Z=5
```

### 插值字符串

在字符串前加上`$`修饰，可以将字符串改为插值字符串格式。  
插值字符串可以接收一对大括号的占位符，里面使用计算的值。

此时的大括号需要连写两个来转义。  
在使用原始字符串时，可以加上多个`$`修饰，  
若如此做，需要使用同等数量的连续`{`和`}`来启用和结束占位。

```csharp
string name1 = "小明";
int age1 = 12;
Console.WriteLine($"名字是:{name1}，年龄是{age1}，转义后的大括号{{}}");
Console.WriteLine($$$"""名字是:{{{name1}}}，年龄是{{{age1}}}""");
```

#### 空格占位

在插值后，可以接一个逗号和一个常量，表示这个值至少要占多少个字符。  
如果没有达到指定数量，就会用空格补齐。达到或超过则无事发生。  
如果是正数，空格会补在前面，如果是负数，空格会补在后面。  

```csharp
Console.WriteLine($"123456789012345678901234567890");
Console.WriteLine($"12|{456,6}0|23456789|{123,-7}|90");
```

#### 格式说明符

在插值后（或空格占位后）可以加上冒号来描述这个类型的格式说明。    
格式说明是由类型单独[定义](https://learn.microsoft.com/zh-cn/dotnet/standard/base-types/standard-numeric-format-strings)的。

```csharp
double e = 12.123456;
int f = 285;
Console.WriteLine($"{f:d5}");//00285，以前导0补足指定数量的数字
Console.WriteLine($"{f:x}");//11d，以16进制显示。字母部分的大小写取决于说明符的大小写
Console.WriteLine($"{d:f3}");//12.123，指定小数位数,会四舍五入或补0来达到指定位数
Console.WriteLine($"{d:e2}");//1.21e+001，科学计数法显示，e后面的数字即小数点后的有效数字，四舍五入
```

 